# Лабораторная работа 2

## Цель работы
- Разработать структуру базы данных.  
- Подключить базу данных к бэкенду.  
- Использовать БД для работы приложения с услугами и заявками.  

## Задачи
1. Создать базу данных PostgreSQL по выбранной теме.  
2. Разработать структуру БД (минимум 4 таблицы).  
3. Подключить БД к Django и использовать её в трёх шаблонах приложения.  
4. Наполнить таблицы данными через Django admin или Adminer.  
5. Реализовать работу приложения через ORM и SQL-запросы:
   - Получение и поиск услуг (ORM).  
   - Добавление услуги в текущую заявку (ORM).     
   - Просмотр текущей заявки (ORM).  
   - Логическое удаление заявки — смена статуса через SQL UPDATE (без ORM).  

## Структура приложения
1. Страница списка услуг  
   - Отображение услуг с фильтрацией по полям.  
   - Возможность добавить услугу в текущую заявку.  
   - Если у пользователя нет заявки в статусе черновик, она создаётся при первом добавлении.  
   - Если заявка уже существует, услуга добавляется в неё.  
   - Если заявка удалена — карточка неактивна.  

2. Страница подробной информации об услуге  
   - Данные из таблицы услуг.  

3. Страница заявки  
   - Отображение состава заявки и связанных услуг.  
   - Поля заявки + карточки услуг (одна строка: поля услуги + количество/порядок/главный).  
   - Кнопка логического удаления заявки (смена статуса).  
   - Удалённые заявки просматривать нельзя.  

## Требования к базе данных

Обязательно наличие 4 таблиц (каскадное удаление запрещено!):

1. Услуги  
   - Поля:  
     - id (PK)  
     - name (наименование)  
     - description (описание)  
     - status (удалена/действует)  
     - image_url (URL изображения, Nullable)  
     - Дополнительные поля по предметной области  

2. Заявки  
   - Поля (все NotNull, кроме модератора):  
     - id (PK)  
     - status (статус заявки)  
     - created_at (дата создания, datetime)  
     - creator_id (создатель, FK → User)  
     - formed_at (дата формирования, datetime, 2 действия создателя)  
     - completed_at (дата завершения, datetime, 2 действия модератора)  
     - moderator_id (FK → User, может быть Null)  
     - Дополнительные поля по предметной области  

3. Заявка–услуга (м-м)  
   - Составной уникальный ключ (request_id, service_id)  
   - Поля:  
     - request_id (FK → заявки)  
     - service_id (FK → услуги)  
     - quantity (количество)  
     - order (порядок)  
     - is_main (главный признак)  
     - Дополнительные поля (например, комментарий)  

4. Пользователи  
   - Используется системная таблица Django User.  
   - Поля: username, password, is_moderator.  

### Статусы заявок
- Черновик  
- Удалён  
- Сформирован  
- Завершён  
- Отклонён  

> У каждого пользователя может быть не более одной заявки в статусе черновик.

### Дополнительные требования
- Одно из полей заявки или м-м рассчитывается при завершении заявки.  
- Названия таблиц и полей должны соответствовать предметной области.  
- ER-диаграмму выполнить в StarUML: таблицы, связи, столбцы, типы данных, длина, PK и FK.  

## Реализация
- Модели Django отражают структуру таблиц.  
- В коде — составной уникальный ключ для таблицы м-м.  
- Реализовать 4 контроллера через ORM:  
  1. Получение услуг.  
  2. Поиск услуг.  
  3. Добавление услуги в заявку.  
  4. Просмотр заявки.  
- Удаление заявки реализовать через SQL UPDATE (без ORM).  

## HTTP методы
- GET — список услуг.  
- GET — поиск услуги.  
- GET — просмотр заявки.  
- POST — добавление услуги в заявку (ORM).  
- POST — удаление заявки (SQL).  

## Порядок показа
1. Показать админку Django/Adminer: добавить новую услугу.  
2. Посмотреть данные через SQL-запрос (SELECT).  
3. Продемонстрировать 3 страницы приложения:  
   - поиск услуги,  
   - удаление заявки,  
   - переход по URL удалённой заявки,  
   - добавление двух услуг в заявку (обновление карточки корзины).  
4. Показать в БД результат логического удаления и новую заявку.  
5. В БД изменить поля заявки и м-м, показать изменения в приложении.  
6. В коде — модели, ключи, контроллеры, SQL для удаления.

## Контрольные вопросы
- Виды БД.  
- SQL-запросы.  
- Курсоры.  
- ORM.  
- Модели и миграции.  
- Чистая архитектура.