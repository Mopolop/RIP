# Лабораторная работа 3

## Цель работы
- Разработать веб-сервис (REST API) для SPA-приложения.  
- Подключить сервис к базе данных через ORM.  
- Реализовать бизнес-логику работы с услугами и заявками.  
- Поддержать загрузку изображений через Minio.  
- Протестировать работу API в Insomnia/Postman.  

---

## Задачи
1. Создать REST API для управления услугами, заявками и пользователями.  
2. Реализовать фильтрацию на стороне бэкенда (услуги, заявки по дате и статусу).  
3. Обеспечить работу с изображениями услуг (загрузка, замена, удаление).  
4. Ограничить изменение системных полей (id, статусы, даты, авторы/модераторы).  
5. Реализовать правила изменения статусов:  
   - **Создатель** может создавать, редактировать, удалять и формировать черновики заявок.  
   - **Модератор** может завершать или отклонять сформированные заявки.  
6. Организовать взаимодействие с БД через ORM.  
7. Настроить сохранение и получение данных через сериализаторы.  
8. Продемонстрировать работу API (21 запрос в Insomnia/Postman).  

---

## Структура API

### Домен «Услуги»
- `GET /api/services` — список услуг с фильтрацией.  
- `GET /api/services/{id}` — подробная информация об услуге.  
- `POST /api/services` — создание услуги (без изображения).  
- `PUT /api/services/{id}` — изменение услуги.  
- `DELETE /api/services/{id}` — удаление услуги и её изображения.  
- `POST /api/services/{id}/image` — добавление/замена изображения (Minio).  
- `POST /api/services/{id}/draft` — добавление услуги в заявку-черновик.  

### Домен «Заявки»
- `GET /api/cart` — корзина (id черновика и количество услуг).  
- `GET /api/orders` — список заявок (фильтрация по статусу и дате формирования).  
- `GET /api/orders/{id}` — получение заявки с услугами и их изображениями.  
- `PUT /api/orders/{id}` — изменение полей заявки.  
- `PUT /api/orders/{id}/form` — сформировать заявку (создателем).  
- `PUT /api/orders/{id}/complete` — завершить/отклонить заявку (модератором).  
- `DELETE /api/orders/{id}` — логическое удаление заявки.  

### Домен «М-М» (услуги в заявке)
- `PUT /api/orders/{orderId}/items/{itemId}` — изменить количество, порядок или значение.  
- `DELETE /api/orders/{orderId}/items/{itemId}` — удалить услугу из заявки.  

### Домен «Пользователь»
- `POST /api/users/register` — регистрация.  
- `POST /api/users/login` — аутентификация.  
- `POST /api/users/logout` — деавторизация.  
- `GET /api/users/me` — данные пользователя (личный кабинет).  
- `PUT /api/users/me` — изменение данных пользователя.  

---

## Требования к реализации
- Работа с БД через ORM.  
- Поддержка хранения изображений через Minio (только в методах добавления/удаления изображений).  
- При завершении заявки вычисляются дополнительные поля (стоимость заказа, дата доставки, поля м-м).  
- Удалённые заявки и услуги клиенту не возвращаются.  
- Один пользователь может иметь только одну заявку в статусе «черновик».  
- Системные поля вычисляются автоматически (через бизнес-логику и авторизацию).  

---

## Структура моделей
1. **Пользователь** (User, системная таблица Django).  
   - username, password, is_moderator.  

2. **Услуги**  
   - id (PK)  
   - name (название)  
   - description (описание)  
   - status (удалена/действует)  
   - image_url (ссылка на изображение, Nullable)  
   - дополнительные поля  

3. **Заявки**  
   - id (PK)  
   - status (статус заявки)  
   - created_at (дата создания)  
   - creator_id (FK → User)  
   - formed_at (дата формирования)  
   - completed_at (дата завершения)  
   - moderator_id (FK → User, Nullable)  
   - дополнительные поля  

4. **Заявка–услуга (м-м)**  
   - request_id (FK → Заявки)  
   - service_id (FK → Услуги)  
   - quantity (количество)  
   - order (порядок)  
   - is_main (главный признак)  
   - дополнительные поля  

---

## Статусы заявок
- Черновик  
- Удалён  
- Сформирован  
- Завершён  
- Отклонён  

---

## Порядок демонстрации
1. Показать коллекцию запросов в Insomnia/Postman (21 запрос).  
2. Выполнить:  
   - GET списка заявок (с фильтром по дате и статусу).  
   - GET черновой заявки.  
   - Удаление заявки.  
   - GET списка услуг (с фильтром).  
   - Добавление новой услуги.  
   - Загрузка изображения к услуге.  
   - Добавление услуги в черновик.  
   - Получение заявки с услугами.  
   - Изменение полей м-м.  
   - Смена статуса заявки: сформировать, завершить, отклонить.  
   - Проверка вычисления стоимости/даты доставки.  
   - Регистрация нового пользователя.  
3. Проверить изменённые данные через SQL SELECT.  
4. Объяснить модели и сериализаторы.  

---

## Контрольные вопросы
- Веб-сервис.  
- REST и RPC.  
- Заголовки и методы HTTP.  
- Версии HTTP.  
- HTTPS.  
- Модель OSI ISO.  
